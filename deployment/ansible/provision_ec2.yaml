#  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
#  SPDX-License-Identifier: MIT-0

# Base provisioning: system dependencies, TLS certs, mock trading server,
# deployment scripts, and shared config. Client-specific provisioning is
# handled by provision_java_client.yaml, provision_rust_client.yaml, or
# provision_cpp_client.yaml.

---
- name: Provision EC2 base and mock trading server
  hosts: aws_ec2
  collections:
    - amazon.aws.ec2_instance
  tasks:
  - name: Install base dependencies for Amazon Linux 2023
    become: yes
    become_user: root
    dnf:
      name:
        - make
        - gcc
        - patch
        - glibc-devel
        - git
        - openssl-devel
        - wget
        - vim
        - tmux
        - numactl
        - ethtool
        - perf
        - procps-ng
        - chrony
        - hwloc
        - util-linux-core
        - sysstat
      state: present

  - name: Generate self-signed certificates
    shell: |
      openssl req -x509 -newkey rsa:4096 -sha256 -days 365 \
      -nodes -keyout localhost.key -out localhost.crt \
      -subj "/CN=localhost" \
      -addext "subjectAltName=DNS:localhost,IP:127.0.0.1"

      openssl pkcs12 -export -out keystore.p12 \
      -inkey localhost.key \
      -in localhost.crt \
      -passout pass:123456
    args:
      creates: keystore.p12

  - name: Copy deployment scripts
    copy:
      src: "{{ item.src }}"
      dest: "{{ item.dest }}"
      owner: ec2-user
      group: ec2-user
      mode: 0755
    loop:
      - { src: ../run_client.sh, dest: /home/ec2-user/run_client.sh }
      - { src: ../run_server.sh, dest: /home/ec2-user/run_server.sh }
      - { src: ../stop.sh, dest: /home/ec2-user/stop.sh }
      - { src: ../latency_report.sh, dest: /home/ec2-user/latency_report.sh }
    tags:
      - deploy

  - name: Create mock-trading-server directory
    file:
      path: /home/ec2-user/mock-trading-server
      state: directory
      owner: ec2-user
      group: ec2-user
      mode: 0755
    tags:
      - deploy

  - name: Copy mock trading server
    synchronize:
      src: ../../mock-trading-server/
      dest: /home/ec2-user/mock-trading-server/
      rsync_opts:
        - "--exclude=target"
    tags:
      - deploy

  - name: Fix mock trading server ownership and permissions
    become: yes
    shell: |
      chown -R ec2-user:ec2-user /home/ec2-user/mock-trading-server
      find /home/ec2-user/mock-trading-server -type f -exec chmod 0644 {} +
      find /home/ec2-user/mock-trading-server -type d -exec chmod 0755 {} +
    tags:
      - deploy

  - name: Download Rust Installer
    get_url:
      url: https://sh.rustup.rs
      dest: /tmp/sh.rustup.rs
      mode: '0755'
      force: 'yes'
    tags:
      - rust

  - name: Install Rust for ec2-user
    become: yes
    become_user: ec2-user
    shell: /tmp/sh.rustup.rs -y
    args:
      creates: /home/ec2-user/.cargo/bin/rustc
    tags:
      - rust

  - name: Build Exchange Server
    become: yes
    become_user: ec2-user
    shell: |
      source $HOME/.cargo/env
      cd /home/ec2-user/mock-trading-server/
      cargo clean
      cargo update
      cargo build --release

  - name: Copy mock trading server configuration toml file
    copy:
      src: ../../mock-trading-server/configuration.toml
      dest: /home/ec2-user/mock-trading-server/configuration.toml
      owner: ec2-user
      group: ec2-user

  - name: Ensure histogram_logs directory exists
    file:
      path: /home/ec2-user/histogram_logs
      state: directory
      owner: ec2-user
      group: ec2-user
      mode: 0755
