#  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
#  SPDX-License-Identifier: MIT-0

---
- name: restart exchange server
  hosts: aws_ec2
  collections:
    - amazon.aws.ec2_instance
  tasks:
  - name: stop exchange server
    become: true
    become_user: root
    shell: |
      pids=$(pgrep -f mock-trading-server || true)
      if [ -n "$pids" ]; then
        echo "$pids" | while read -r pid; do
          echo "Shutting down PID: $pid"
          kill -9 "$pid" 2>/dev/null || true
        done
      else
        echo "No mock-trading-server process found"
      fi
    ignore_errors: true

  - name: kill stale tmux server session
    shell: tmux kill-session -t test_server 2>/dev/null || true
    ignore_errors: true

  - name: start exchange server
    become: true
    become_user: root
    shell: tmux new-session -d -s test_server 'bash -c "cd /home/ec2-user; ./run_server.sh >> server_output.log 2>&1"'
    async: 45
    poll: 0
