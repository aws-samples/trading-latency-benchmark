#  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
#  SPDX-License-Identifier: MIT-0

---
- name: Provision EC2 for Rust HFT client
  hosts: aws_ec2
  collections:
    - amazon.aws.ec2_instance
  tasks:
  - name: Install system dependencies for Amazon Linux 2023
    become: yes
    become_user: root
    dnf:
      name:
        - make
        - gcc
        - patch
        - glibc-devel
        - git
        - openssl-devel
        - pkg-config
        - numactl
        - ethtool
        - perf
        - procps-ng
        - chrony
        - hwloc
        - util-linux-core
        - sysstat
      state: present

  - name: Download Rust installer
    get_url:
      url: https://sh.rustup.rs
      dest: /tmp/sh.rustup.rs
      mode: '0755'
      force: 'yes'
    tags:
      - rust

  - name: Install Rust for ec2-user
    become: yes
    become_user: ec2-user
    shell: /tmp/sh.rustup.rs -y
    args:
      creates: /home/ec2-user/.cargo/bin/rustc
    tags:
      - rust

  - name: Generate self-signed certificates
    shell: |
      openssl req -x509 -newkey rsa:4096 -sha256 -days 365 \
      -nodes -keyout localhost.key -out localhost.crt \
      -subj "/CN=localhost" \
      -addext "subjectAltName=DNS:localhost,IP:127.0.0.1"

      openssl pkcs12 -export -out keystore.p12 \
      -inkey localhost.key \
      -in localhost.crt \
      -passout pass:123456
    args:
      creates: keystore.p12

  - name: Create rust-hft-client directory
    file:
      path: /home/ec2-user/rust-hft-client
      state: directory
      owner: ec2-user
      group: ec2-user
      mode: 0755
    tags:
      - deploy

  - name: Copy Rust HFT client source
    synchronize:
      src: ../../hft_client/rust_client/
      dest: /home/ec2-user/rust-hft-client/
      rsync_opts:
        - "--exclude=target"
        - "--exclude=.kiro"
        - "--exclude=hw_sequencer"
    tags:
      - deploy

  - name: Fix Rust client ownership and permissions
    become: yes
    shell: |
      chown -R ec2-user:ec2-user /home/ec2-user/rust-hft-client
      find /home/ec2-user/rust-hft-client -type f -exec chmod 0644 {} +
      find /home/ec2-user/rust-hft-client -type d -exec chmod 0755 {} +
    tags:
      - deploy

  - name: Build Rust HFT client
    become: yes
    become_user: ec2-user
    shell: |
      source $HOME/.cargo/env
      cd /home/ec2-user/rust-hft-client
      cargo build --release
    register: rust_build
    tags:
      - build

  - name: Verify Rust client binary exists
    stat:
      path: /home/ec2-user/rust-hft-client/target/release/hft_client
    register: rust_binary

  - name: Report build result
    debug:
      msg: "Rust HFT client binary: {{ 'BUILT (' + rust_binary.stat.size|string + ' bytes)' if rust_binary.stat.exists else 'BUILD FAILED' }}"

  - name: Copy client config properties
    copy:
      src: ../../hft_client/java_client/src/main/resources/config.properties
      dest: /home/ec2-user/config.properties
      owner: ec2-user
      group: ec2-user
    tags:
      - configure

  - name: Configure trading server endpoint in config.properties
    lineinfile:
      path: /home/ec2-user/config.properties
      regexp: '^HOST='
      line: "HOST={{ trading_server_host }}"
    when: trading_server_host is defined
    tags:
      - configure

  - name: Configure test size in config.properties
    lineinfile:
      path: /home/ec2-user/config.properties
      regexp: '^TEST_SIZE='
      line: "TEST_SIZE={{ trading_test_size }}"
    when: trading_test_size is defined
    tags:
      - configure

  - name: Ensure histogram_logs directory exists
    file:
      path: /home/ec2-user/histogram_logs
      state: directory
      owner: ec2-user
      group: ec2-user
      mode: 0755

  - name: Copy deployment scripts
    copy:
      src: "{{ item.src }}"
      dest: "{{ item.dest }}"
      owner: ec2-user
      group: ec2-user
      mode: 0755
    loop:
      - { src: ../run_client.sh, dest: /home/ec2-user/run_client.sh }
      - { src: ../run_server.sh, dest: /home/ec2-user/run_server.sh }
      - { src: ../stop.sh, dest: /home/ec2-user/stop.sh }
      - { src: ../latency_report.sh, dest: /home/ec2-user/latency_report.sh }
    tags:
      - deploy
